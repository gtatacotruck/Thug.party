<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Thug.party</title>
<style>
  /* Base Body Styles */
  body {margin:0;background:#111;color:#ccc;font-family:Verdana,sans-serif;}
  
  /* Standard Content Visibility (Hidden by default to be controlled by JS) */
  .app-content { visibility: hidden; }

  header {background:#222;padding:15px;text-align:center;border-bottom:3px solid #f00;}
  h1 {margin:0;color:#f00;font-size:2.2em;text-shadow:0 0 10px #f00;}
  nav {background:#1a1a1a;padding:10px;overflow-x:auto;white-space: nowrap;}
  .board {display:inline-block;margin:8px;padding:12px;background:#222;border:2px solid #444;border-radius:8px;width:180px;cursor:pointer;vertical-align: top;}
  .board:hover {background:#333;border-color:#f00;}
  .desc {display:none;background:#000;padding:8px;border:1px solid #555;margin-top:5px;}
  .board:hover .desc {display:block;}
  #content {padding:20px;}

  /* Thread/Post Styling for new features */
  .thread {background:#1e1e1e;margin:20px 0;padding:15px;border:1px solid #444;border-radius:6px; position: relative;}
  .thread.pinned {border: 2px solid #f00; box-shadow: 0 0 5px rgba(255,0,0,0.5);} 
  .post {margin:10px 0;padding:12px;background:#262626;border-left:4px solid #777;border-radius:4px;}
  .op {border-left:8px solid #f00;}

  /* Role Styles */
  .name {font-weight:bold;}
  .owner {color:#f00;font-weight:bold;}
  .admin {color:#0ff;}
  .mod {color:#ff0;} 
  .coal {color: #555; font-style: italic;} 
  .verified {color:#0f0;}
  .time-role {font-size:0.85em;color:#888;}
  .clickable-name {cursor: pointer;} 

  /* Text Formatting */
  .greentext {color: #789922;} 
  .colored-text {display: block; margin-top: 5px; margin-bottom: 5px;}
  
  /* Tombstone/Shaken Post Style */
  .shaken {font-style: italic; color: #555; background: #333; border-left: 4px solid #f80;}
  .tombstone-text {color: #f80; font-weight: bold;}
  
  /* Voting UI */
  .vote-box {display: inline-flex; align-items: center; margin-right: 15px; background: #111; padding: 2px 8px; border-radius: 4px; float: right; margin-left: 10px;}
  .vote-btn {cursor: pointer; padding: 0 5px; font-weight: bold; user-select: none;}
  .vote-btn:hover {color: #fff;}
  .up {color: #0f0;} .down {color: #f44;}
  .count {margin: 0 8px; font-size: 0.9em; font-family: monospace;}
  .pin-action {color:#0f0; cursor:pointer; margin-left:10px;}

  form {margin:25px 0;background:#222;padding:15px;border-radius:6px;}
  input, textarea {width:100%;background:#333;color:#fff;border:1px solid #555;padding:8px;margin:8px 0;border-radius:4px; box-sizing: border-box;}
  button {background:#f00;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:bold;}
  button:hover {background:#ff3333;}
  #owner-panel, #mod-panel {background:#300;padding:20px;margin:20px 0;border:2px solid #f00;border-radius:8px;display:none;}
  #audit-log {background:#200;padding:15px;margin:10px 0;border:1px solid #f00;border-radius:6px;max-height:300px;overflow-y:auto;}
  .report {color:#f88;cursor:pointer;font-size:0.9em;}
  .delete, .shake {color:#f00;cursor:pointer;margin-left:15px;}
  .shake {color: orange;} 
  #raid-alert {background:#800;padding:20px;margin:20px 0;border:3px solid #f00;text-align:center;font-size:1.5em;color:#ff0;display:none;}
  #captcha {background:#222;padding:20px;border-radius:8px;text-align:center;margin:20px 0;}
  .cap-btn {width:80px;height:80px;margin:10px;border-radius:12px;cursor:pointer;}
  
  /* Status Overlay Styling */
  #status-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      display: none; 
      text-align: center;
      padding-top: 40vh;
  }
  #status-overlay h2 {
      color: #f00;
      font-size: 2.5em;
      text-shadow: 0 0 10px #f00;
  }
</style>
</head>
<body>

<script>
    // Note: This script uses a basic fetch to reset the Firebase status outside of the module scope.
    // It is temporary and should be removed after the first load to prevent data loss.
    // You MUST ensure the firebaseConfig details are correct below for the reset to work.
    
    const hardReset = async () => {
        // 1. Wipe local storage (clears user, accounts, roles, audit logs, etc.)
        const keysToClear = ["currentUser_clean", "reports_clean", "roles_clean", "accounts_clean", "audit_clean", "loggedUsers_clean", "siteStatus_clean"];
        keysToClear.forEach(key => localStorage.removeItem(key));

        // 2. Reset Firebase siteStatus to 'normal' (requires direct database access)
        const databaseURL = "https://thugparty1-default-rtdb.firebaseio.com"; 
        const statusPath = "siteStatus_clean.json";
        const newStatus = {mode: "normal", until: 0};
        
        try {
             // We use a PUT request to the Firebase REST API to force the status change
            const response = await fetch(`${databaseURL}/${statusPath}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newStatus)
            });

            if (response.ok) {
                console.log("Hard reset successful. Site status set to 'normal'.");
            } else {
                console.error("Firebase reset failed:", response.status, await response.text());
            }
        } catch (error) {
            console.error("Network error during Firebase reset:", error);
        }

        // 3. Force a reload with the clean slate
        window.location.reload();
    };

    // Only run if a specific local indicator is present or if we suspect an issue.
    // For this fix, we'll run it once automatically.
    // **IMPORTANT: Comment out or remove the line below after confirming the fix.**
    // hardReset(); // <--- REMOVE THIS LINE AFTER THE FIRST SUCCESSFUL LOAD
</script>


<div id="status-overlay"></div>

<header class="app-content"><h1>Thug.party</h1></header>
<nav class="app-content">
  <div class="board" data-board="rules"><strong>/rules/</strong><div class="desc">The Law</div></div> 
  <div class="board" data-board="qa"><strong>/qa/</strong><div class="desc">Questions & Answers</div></div>
  <div class="board" data-board="thug"><strong>/thug/</strong><div class="desc">General thug discussion</div></div>
  <div class="board" data-board="pol"><strong>/pol/</strong><div class="desc">Politically Incorrect</div></div>
  <div class="board" data-board="shit"><strong>/shit/</strong><div class="desc">Shitposting</div></div>
  <div class="board" data-board="raid"><strong>/raid/</strong><div class="desc">Raids & Operations</div></div>
  <div class="board" data-board="spam"><strong>/spam/</strong><div class="desc">Spam and flood zone</div></div>
</nav>

<div id="raid-alert" class="app-content">RAID INCOMING – TOO MANY NEW USERS<br><button onclick="dismissRaid()">Not a raid</button></div>

<div id="content" class="app-content"></div>

<div id="owner-panel" class="app-content">
  <h2>Owner Panel (GTAtacotruck)</h2>
  <button onclick="siteDown()">Site Down (minutes)</button>
  <button onclick="updateMode()">SITE UPDATED – REFRESH</button>
  <button onclick="normalMode()">Back to Normal</button>
  <button onclick="clearAllPosts()">Wipe All Posts</button>
  <button onclick="grantRole()">Grant Role</button>
  <div id="audit-log"><strong>Audit Log</strong><br></div>
</div>

<div id="mod-panel" class="app-content">
  <h2>Jannie/Admin Panel</h2>
  <div>Logged in users: <span id="users-list"></span></div>
  <div id="reports"></div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref as dbRef, onValue, push, remove, set, runTransaction } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

const firebaseConfig = {
  apiKey: "AIzaSyCuje9LHZwow99YpV5LqHtQm2LY3NLOgPM",
  authDomain: "thugparty1.firebaseapp.com",
  databaseURL: "https://thugparty1-default-rtdb.firebaseio.com",
  projectId: "thugparty1",
  storageBucket: "thugparty1.firebasestorage.app",
  messagingSenderId: "663564615086",
  appId: "1:663564615086:web:6b68f41403f5c8e30d1c3f"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

let myName = localStorage.getItem("currentUser_clean");
let currentBoard = "thug";
const boards = ["rules", "qa","thug","pol","shit","raid","spam"]; 

let reports = JSON.parse(localStorage.getItem("reports_clean") || "[]");
let roles = JSON.parse(localStorage.getItem("roles_clean") || '{"GTAtacotruck":"owner"}');
let accounts = JSON.parse(localStorage.getItem("accounts_clean") || '{"GTAtacotruck":{"pass":"her0in","verified":true}}');
let audit = JSON.parse(localStorage.getItem("audit_clean") || "[]");
let loggedUsers = JSON.parse(localStorage.getItem("loggedUsers_clean") || "{}");

// --- REVISED SITE STATUS LOGIC ---

// Helper to control visibility of the entire application content
function setAppVisibility(visible) {
    document.querySelectorAll('.app-content').forEach(el => {
        el.style.visibility = visible ? 'visible' : 'hidden';
        el.style.display = visible ? '' : 'none';
    });
}

function handleSiteStatus(status) {
    const overlay = document.getElementById('status-overlay');
    
    // 1. Check for Site Down
    if (status.mode === "down" && status.until > Date.now()) {
        setAppVisibility(false);
        overlay.style.display = 'block';
        overlay.innerHTML = "<h2 style='color:#f00;'>sorry my thugs the site is down for now!</h2>";
        return;
    }
    
    // 2. Check for Site Update (Requires refresh)
    if (status.mode === "update") {
        setAppVisibility(false);
        overlay.style.display = 'block';
        overlay.innerHTML = "<h2 style='color:#ff0;'>SITE HAS BEEN UPDATED – REFRESH FOR THE NEW UPDATE</h2>";
        return;
    }
    
    // 3. Normal Mode: Hide overlay and initialize site content
    if (status.mode === "normal") {
        overlay.style.display = 'none';
        setAppVisibility(true);

        if (!myName) {
          showCaptcha();
        } else {
          if (myName === "GTAtacotruck") roles[myName] = "owner";
          
          if (document.getElementById("threads") === null || document.getElementById("content").innerHTML === "") {
              renderBoard("thug");
          }
        }
        
        // Panel initialization and recurring tasks
        if (roles[myName] === "owner") {
          document.getElementById("owner-panel").style.display = "block";
          showAudit();
        } else if (document.getElementById("owner-panel")) {
             document.getElementById("owner-panel").style.display = "none";
        }
        
        if (["owner","admin","mod"].includes(roles[myName])) {
          document.getElementById("mod-panel").style.display = "block";
          showReports();
          if (!window.userUpdateInterval) { 
            window.userUpdateInterval = setInterval(updateUsers, 8000);
          }
        } else if (document.getElementById("mod-panel")) {
            document.getElementById("mod-panel").style.display = "none";
        }

        // Initialize board nav listeners (only once)
        if (!window.boardNavInitialized) {
            document.querySelectorAll(".board").forEach(b =>
                b.onclick = () => renderBoard(b.dataset.board)
            );
            window.boardNavInitialized = true;
        }
    }
}

// Global listener for site status updates
const statusRef = dbRef(db, 'siteStatus_clean');
onValue(statusRef, (snapshot) => {
    const status = snapshot.val() || {mode: "normal"}; 
    handleSiteStatus(status);
});

// --- END REVISED SITE STATUS LOGIC ---

function showCaptcha() {
  let div = document.createElement("div");
  div.id = "captcha";
  div.innerHTML = "<p>Click the GREEN button</p>";
  let colors = ["red","blue","yellow","green"];
  colors.sort(() => Math.random() - 0.5);
  colors.forEach(c => {
    let b = document.createElement("button");
    b.className = "cap-btn";
    b.style.background = c;
    b.onclick = () => {
      if (c === "green") {
        div.remove();
        login();
      } else {
        alert("Wrong button. Try again.");
        showCaptcha();
      }
    };
    div.appendChild(b);
  });
  document.getElementById("content").appendChild(div); 
}

function login() {
  let name = prompt("Username:");
  if (!name) return;
  let pass = prompt("Password (leave blank for new account):");
  if (accounts[name] && accounts[name].pass !== pass) {
    alert("Wrong password");
    return login();
  }
  if (!accounts[name]) {
    accounts[name] = {pass: pass || "", verified: false};
    localStorage.setItem("accounts_clean", JSON.stringify(accounts));
    alert("New unverified account created");
  }
  myName = name;
  if (!loggedUsers[myName]) loggedUsers[myName] = {start: Date.now(), last: Date.now()};
  loggedUsers[myName].last = Date.now();
  localStorage.setItem("loggedUsers_clean", JSON.stringify(loggedUsers));
  localStorage.setItem("currentUser_clean", myName);
  location.reload();
}

function logout() {
  localStorage.removeItem("currentUser_clean");
  location.reload();
}

function getTimeRole() {
  if (!myName || !loggedUsers[myName]) return "";
  let mins = Math.floor((Date.now() - loggedUsers[myName].start) / 60000);
  if (mins < 250) return "nuthug ★";
  if (mins < 350) return "midthug ♦";
  return "oldthug ♠";
}

function renderBoard(board) {
  currentBoard = board;
  let html = `<h2>/${board}/</h2>`;
  
  if (board === "rules") {
      html += `<div class="thread">
          <h3>Community Rules</h3>
          <p>This is a place for discussion. Respect the law and the channel.</p>
          <ul>
              <li>Do not post illegal content or gore.</li>
              <li>Do not post irrelevant things in the wrong channel.</li>
              <li>Posts by NOTORIOUS COALPOSTERS expire in 4 hours.</li>
              <li>Getting -100 score makes you a COALPOSTER; getting +20 score removes it.</li>
              <li>**Formatting:** Use &lt;#RRGGBB&gt; for custom color, or &gt; at the start of a line for greentext.</li>
          </ul>
      </div>`;
  } else {
      let isCoalposter = roles[myName] === "coal";
      let statusText = isCoalposter ? `You are: ${myName} <span class="coal">[NOTORIOUS COALPOSTER]</span>` : `You are: ${myName}`;

      html += `<p>${statusText} ${accounts[myName]?.verified ? "(verified)" : "(unverified)"} <button onclick="logout()">Logout</button></p>
      <form id="newthread">
        Name: <input id="name" value="${myName}" readonly><br>
        Comment: <textarea id="comment" placeholder="${isCoalposter ? 'Your posts will expire in 4 hours...' : ''}"></textarea><br>
        File: <input type="file" id="file"><br>
        <button type="button" onclick="createThread()">Post</button>
      </form><div id="threads"></div>`;
  }
  
  document.getElementById("content").innerHTML = html;
  if (board !== "rules") loadPosts(board);
}

function loadPosts(board) {
  const postsRef = dbRef(db, 'posts/' + board);
  onValue(postsRef, (snapshot) => {
    const data = snapshot.val();
    let threads = [];
    if (data) {
      for (let key in data) {
        let t = data[key];
        if (t.expiresAt && Date.now() > t.expiresAt) continue; 
        threads.push({...t, id: key});
      }
    }
    
    threads.sort((a, b) => {
        let aPinned = a.pinnedUntil && a.pinnedUntil > Date.now();
        let bPinned = b.pinnedUntil && b.pinnedUntil > Date.now();
        if (aPinned && !bPinned) return -1;
        if (!aPinned && bPinned) return 1;
        return b.op.time - a.op.time;
    });
    
    let threadsDiv = document.getElementById("threads");
    if (threadsDiv) {
        threadsDiv.innerHTML = "";
        threads.forEach(renderThread);
    }
  });
}

async function createThread() {
  let comment = document.getElementById("comment").value.trim();
  if (!comment) return;
  
  let file = document.getElementById("file").files[0];
  let fileUrl = "";

  if (file) {
      try {
          const storageReference = storageRef(storage, `${currentBoard}/${Date.now()}_${file.name}`);
          const snapshot = await uploadBytes(storageReference, file);
          fileUrl = await getDownloadURL(snapshot.ref);
      } catch (error) {
          console.error("Upload failed:", error);
          alert("Image upload failed. Posting thread without image.");
          fileUrl = "";
      }
  }

  let expiry = roles[myName] === "coal" ? Date.now() + (4 * 60 * 60 * 1000) : null;

  let thread = {
      op:{name:myName, comment, fileUrl, time:Date.now(), verified:accounts[myName]?.verified, score: 0, voters: {}, tombstoned: false},
      replies:[],
      pinnedUntil: 0,
      expiresAt: expiry 
  };
  push(dbRef(db, 'posts/' + currentBoard), thread);
  document.getElementById("comment").value = "";
  document.getElementById("file").value = "";
}

function renderThread(thread) {
  const isPinned = thread.pinnedUntil && thread.pinnedUntil > Date.now();
  let div = document.createElement("div");
  div.className = `thread ${isPinned ? 'pinned' : ''}`;
  
  let pinButton = "";
  if (["owner","admin","mod"].includes(roles[myName])) {
    pinButton = `<span class="pin-action" onclick="togglePin('${thread.id}', ${isPinned})">${isPinned ? '[Unpin]' : '[Pin 24h]'}</span>`;
  }
  
  div.innerHTML = (isPinned ? `<b style="color:red">[PINNED]</b> ` : "") + renderPost(thread.op, thread.id, true) + pinButton;
  
  if (thread.replies) {
      Object.entries(thread.replies).forEach(([rId, r]) => {
          if (r.expiresAt && Date.now() > r.expiresAt) return;
          div.innerHTML += renderPost(r, thread.id, false, rId);
      });
  }

  div.innerHTML += `<form><input value="${myName}" readonly id="rname${thread.id}">
    <textarea id="rcomment${thread.id}"></textarea>
    <button type="button" onclick="reply('${thread.id}')">Post</button></form>`;
  document.getElementById("threads").appendChild(div);
}

function formatComment(post) {
    let comment = post.comment || "";
    
    if (post.tombstoned) {
        return `<span class="tombstone-text">is user posted illegal material laugh at this loser</span>`;
    }

    let content = comment.replace(/\n/g, '<br>');
    let colorTagMatch = content.match(/^&lt;#([0-9a-fA-F]{6})&gt;/i);
    let hexColor = null;

    if (colorTagMatch) {
        hexColor = '#' + colorTagMatch[1];
        content = content.substring(colorTagMatch[0].length);
    }
    
    let lines = content.split('<br>');
    let formattedLines = lines.map(line => {
        if (line.trim().startsWith('>')) {
            return `<span class="greentext">${line}</span>`;
        }
        return line;
    });

    content = formattedLines.join('<br>');
    
    if (hexColor) {
        content = `<span class="colored-text" style="color:${hexColor}">${content}</span>`;
    }
    
    return content;
}

function renderPost(post, threadId, isOP = false, replyId = null) {
  let role = roles[post.name] || "user";
  let verified = accounts[post.name]?.verified ? "(verified)" : "(unverified)";
  let roleClass = role === "owner" ? "owner" : role === "admin" ? "admin" : role === "mod" ? "mod" : role === "coal" ? "coal" : "";
  let roleDisplay = role === "coal" ? " [NOTORIOUS COALPOSTER]" : role ? ` [${role}]` : "";
  let postId = replyId ? replyId : "op";
  let score = post.score || 0;
  
  let isStaff = ["owner","admin","mod"].includes(roles[myName]);
  
  let nameSpan = `<span class="name ${roleClass} ${isStaff ? 'clickable-name' : ''}" 
                      onclick="${isStaff ? `toggleVerification('${post.name}')` : ''}">
                      ${post.name}${roleDisplay} ${verified} ${getTimeRole()}
                  </span>`;

  let voteHtml = `<div class="vote-box">
        <span class="vote-btn up" onclick="vote('${threadId}','${postId}','up')">▲</span>
        <span class="count" style="color:${score >= 0 ? '#0f0' : '#f44'}">${score}</span>
        <span class="vote-btn down" onclick="vote('${threadId}','${postId}','down')">▼</span>
    </div>`;
    
  let postContent = formatComment(post);
  let postClass = `post ${isOP ? 'op' : ''} ${post.tombstoned ? 'shaken' : ''}`;

  let moderationActions = '';
  if (isStaff) {
      moderationActions = `
          <span class="report" onclick="reportPost('${threadId}',${post.time})">Report</span>
          <span class="shake" onclick="tombstonePost('${currentBoard}','${threadId}',${post.time})">Shake</span>
          <span class="delete" onclick="deletePost('${currentBoard}','${threadId}',${post.time})">Delete</span>`;
  } else {
      moderationActions = `<span class="report" onclick="reportPost('${threadId}',${post.time})">Report</span>`;
  }


  return `<div class="${postClass}">
    ${voteHtml}
    ${nameSpan}
    <span>${new Date(post.time).toLocaleString()}</span>
    ${(post.fileUrl && !post.tombstoned) ? `<img src="${post.fileUrl}" style="max-width:300px"><br>` : ''}
    <p>${postContent}</p>
    ${moderationActions}
  </div>`;
}

function reply(threadId) {
  let comment = document.getElementById("rcomment" + threadId).value.trim();
  if (!comment) return;

  let expiry = roles[myName] === "coal" ? Date.now() + (4 * 60 * 60 * 1000) : null;
  
  let reply = {
      name:myName, 
      comment, 
      time:Date.now(), 
      verified:accounts[myName]?.verified, 
      score: 0, 
      voters: {}, 
      expiresAt: expiry,
      tombstoned: false
  };
  push(dbRef(db, 'posts/' + currentBoard + '/' + threadId + '/replies'), reply);
  document.getElementById("rcomment" + threadId).value = "";
}

function togglePin(tId, currentlyPinned) {
    if (!["owner","admin","mod"].includes(roles[myName])) return;
    const pinUntil = currentlyPinned ? 0 : Date.now() + (24 * 60 * 60 * 1000); 
    set(dbRef(db, `posts/${currentBoard}/${tId}/pinnedUntil`), pinUntil);
}

function toggleVerification(targetName) {
    if (!["owner","admin","mod"].includes(roles[myName])) return;
    if (!accounts[targetName]) return alert("Account not found.");

    const currentStatus = accounts[targetName].verified;
    const newStatus = !currentStatus;
    
    if (confirm(`Toggle verification for ${targetName}? Current: ${currentStatus ? 'Verified' : 'Unverified'}.`)) {
        accounts[targetName].verified = newStatus;
        localStorage.setItem("accounts_clean", JSON.stringify(accounts));
        audit.push(`${myName} ${newStatus ? 'VERIFIED' : 'UNVERIFIED'} user ${targetName}`);
        localStorage.setItem("audit_clean", JSON.stringify(audit));
        showAudit();
        renderBoard(currentBoard); 
    }
}

function tombstonePost(board, threadId, postTime) {
    if (!["owner","admin","mod"].includes(roles[myName])) return;
    
    const postRef = dbRef(db, `posts/${board}/${threadId}`);
    onValue(postRef, snap => {
        let data = snap.val();
        if (!data) return;

        let path = '';
        if (data.op.time === postTime) {
            path = `posts/${board}/${threadId}/op`;
        } else if (data.replies) {
            let entries = Object.entries(data.replies);
            let targetEntry = entries.find(([key, val]) => val.time === postTime);
            if (targetEntry) {
                path = `posts/${board}/${threadId}/replies/${targetEntry[0]}`;
            }
        }

        if (path) {
            runTransaction(dbRef(db, path), (post) => {
                if (post) {
                    post.comment = "";
                    post.fileUrl = "";
                    post.tombstoned = true;
                }
                return post;
            }).then(() => {
                audit.push(`${myName} SHAKED post ${postTime} on /${board}/`);
                localStorage.setItem("audit_clean", JSON.stringify(audit));
                showAudit();
            });
        }
    }, { once: true });
}

async function vote(tId, pId, type) {
    let path = `posts/${currentBoard}/${tId}` + (pId === 'op' ? '/op' : `/replies/${pId}`);
    const postRef = dbRef(db, path);
    
    await runTransaction(postRef, (post) => {
        if (post) {
            if (!post.voters) post.voters = {};
            let currentVote = post.voters[myName] || 0;
            let newVote = type === 'up' ? 1 : -1;

            if (currentVote === newVote) return; 

            post.score = (post.score || 0) - currentVote + newVote;
            post.voters[myName] = newVote;

            if (post.score <= -100 && roles[post.name] !== "owner") {
                updateUserRole(post.name, "coal");
            }
            if (post.score >= 20 && roles[post.name] === "coal") {
                updateUserRole(post.name, "user");
            }
        }
        return post;
    });
}

function updateUserRole(targetName, newRole) {
  roles[targetName] = newRole;
  localStorage.setItem("roles_clean", JSON.stringify(roles));
  if (targetName === myName) location.reload(); 
}

function reportPost(threadId, postTime) {
  reports.push({board:currentBoard, threadId, postTime, reporter:myName});
  localStorage.setItem("reports_clean", JSON.stringify(reports));
  alert("Reported");
  showReports();
}

function deletePost(board, threadId, postTime) {
  if (!["owner","admin","mod"].includes(roles[myName])) return;
  const postRef = dbRef(db, `posts/${board}/${threadId}`);
  onValue(postRef, snap => {
    let data = snap.val();
    if (!data) return;

    if (data.op.time === postTime) {
      remove(postRef);
    } else if (data.replies) {
      let entries = Object.entries(data.replies);
      let targetEntry = entries.find(([key, val]) => val.time === postTime);
      if (targetEntry) {
          remove(dbRef(db, `posts/${board}/${threadId}/replies/${targetEntry[0]}`));
      }
    }

    audit.push(`${myName} DELETED post ${postTime} on /${board}/`);
    localStorage.setItem("audit_clean", JSON.stringify(audit));
    showAudit();
  }, { once: true });
}

function showReports() {
  if (!["owner","admin","mod"].includes(roles[myName])) return;
  const panel = document.getElementById("mod-panel");
  panel.style.display = "block";
  let html = "<h2>Jannie/Admin Panel</h2><div id='reportlist'>";
  reports.forEach(r => {
    html += `<p>${r.reporter} → /${r.board}/ ${r.threadId}
      <button onclick="deletePost('${r.board}','${r.threadId}',${r.postTime})">Delete</button></p>`;
  });
  html += "</div>";
  panel.innerHTML = html;
}

function showAudit() {
  if (roles[myName] !== "owner") return;
  const logDiv = document.getElementById("audit-log");
  if (logDiv) {
      logDiv.innerHTML = "<strong>Audit Log</strong><br>" + audit.slice(-50).join("<br>");
  }
}

function updateUsers() {
  let list = document.getElementById("users-list");
  if (list) list.innerText = Object.keys(loggedUsers).join(", ");
}

/* OWNER CONTROLS */

function siteDown() {
  if (roles[myName] !== "owner") return;
  let mins = prompt("Minutes?");
  if (!mins) return;
  const until = Date.now() + mins*60000;
  set(statusRef, {mode:"down", until: until});
}

function updateMode() {
  if (roles[myName] !== "owner") return;
  set(statusRef, {mode:"update", until: 0});
}

function normalMode() {
  if (roles[myName] !== "owner") return;
  set(statusRef, {mode:"normal", until: 0});
}

function clearAllPosts() {
  if (roles[myName] !== "owner") return;
  if (!confirm("Wipe everything?")) return;
  boards.forEach(b => remove(dbRef(db, 'posts/' + b)));
}

function grantRole() {
  if (roles[myName] !== "owner") return;
  let name = prompt("User:");
  let role = prompt("Role (mod/admin/coal/user):");
  if (!name || !role) return;
  roles[name] = role;
  localStorage.setItem("roles_clean", JSON.stringify(roles));
}

/* EXPOSE TO GLOBAL SCOPE */
window.logout = logout;
window.createThread = createThread;
window.reply = reply;
window.reportPost = reportPost;
window.deletePost = deletePost;
window.tombstonePost = tombstonePost;
window.toggleVerification = toggleVerification;
window.siteDown = siteDown;
window.updateMode = updateMode;
window.normalMode = normalMode;
window.clearAllPosts = clearAllPosts;
window.grantRole = grantRole;
window.dismissRaid = () => { document.getElementById('raid-alert').style.display = 'none'; };
window.vote = vote;
window.togglePin = togglePin;

</script>
</body>
</html>
