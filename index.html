<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Thug.party</title>
<style>
  body {margin:0;background:#111;color:#ccc;font-family:Verdana,sans-serif;}
  header {background:#222;padding:15px;text-align:center;border-bottom:3px solid #f00;}
  h1 {margin:0;color:#f00;font-size:2.2em;text-shadow:0 0 10px #f00;}
  nav {background:#1a1a1a;padding:10px;overflow-x:auto;}
  .board {display:inline-block;margin:8px;padding:12px;background:#222;border:2px solid #444;border-radius:8px;width:180px;cursor:pointer;}
  .board:hover {background:#333;border-color:#f00;}
  .desc {display:none;background:#000;padding:8px;border:1px solid #555;margin-top:5px;}
  .board:hover .desc {display:block;}
  #content {padding:20px;}
  .thread {background:#1e1e1e;margin:20px 0;padding:15px;border:1px solid #444;border-radius:6px;}
  .post {margin:10px 0;padding:12px;background:#262626;border-left:4px solid #777;border-radius:4px;}
  .op {border-left:8px solid #f00;}
  .name {font-weight:bold;}
  .owner {color:#f00;font-weight:bold;}
  .admin {color:#0ff;}
  .jannie {color:#ff0;}
  .verified {color:#0f0;}
  .time-role {font-size:0.85em;color:#888;}
  form {margin:25px 0;background:#222;padding:15px;border-radius:6px;}
  input, textarea {width:100%;background:#333;color:#fff;border:1px solid #555;padding:8px;margin:8px 0;border-radius:4px;}
  button {background:#f00;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:bold;}
  button:hover {background:#ff3333;}
  #owner-panel, #mod-panel {background:#300;padding:20px;margin:20px 0;border:2px solid #f00;border-radius:8px;display:none;}
  #audit-log {background:#200;padding:15px;margin:10px 0;border:1px solid #f00;border-radius:6px;max-height:300px;overflow-y:auto;}
  .report {color:#f88;cursor:pointer;font-size:0.9em;}
  .delete {color:#f00;cursor:pointer;margin-left:15px;}
  #raid-alert {background:#800;padding:20px;margin:20px 0;border:3px solid #f00;text-align:center;font-size:1.5em;color:#ff0;display:none;}
  #captcha {background:#222;padding:20px;border-radius:8px;text-align:center;margin:20px 0;}
  .cap-btn {width:80px;height:80px;margin:10px;border-radius:12px;cursor:pointer;}
</style>
</head>
<body>
<header><h1>Thug.party</h1></header>
<nav>
  <div class="board" data-board="qa"><strong>/qa/</strong><div class="desc">Questions & Answers</div></div>
  <div class="board" data-board="thug"><strong>/thug/</strong><div class="desc">General thug discussion</div></div>
  <div class="board" data-board="pol"><strong>/pol/</strong><div class="desc">Politically Incorrect</div></div>
  <div class="board" data-board="shit"><strong>/shit/</strong><div class="desc">Shitposting</div></div>
  <div class="board" data-board="raid"><strong>/raid/</strong><div class="desc">Raids & Operations</div></div>
  <div class="board" data-board="spam"><strong>/spam/</strong><div class="desc">Spam and flood zone</div></div>
</nav>

<div id="raid-alert">RAID INCOMING – TOO MANY NEW USERS<br><button onclick="dismissRaid()">Not a raid</button></div>

<div id="content"></div>

<div id="owner-panel">
  <h2>Owner Panel (GTAtacotruck)</h2>
  <button onclick="siteDown()">Site Down (minutes)</button>
  <button onclick="updateMode()">SITE UPDATED – REFRESH</button>
  <button onclick="normalMode()">Back to Normal</button>
  <button onclick="clearAllPosts()">Wipe All Posts</button>
  <button onclick="grantRole()">Grant Role</button>
  <div id="audit-log"><strong>Audit Log</strong><br></div>
</div>

<div id="mod-panel">
  <h2>Jannie/Admin Panel</h2>
  <div>Logged in users: <span id="users-list"></span></div>
  <div id="reports"></div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, onValue, push, set, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig = {
  apiKey: process.env.FIREBASE_API_KEY || "AIzaSyAuFGt2mK5VedGIMy2D3V1NlbIXaD554TQ",
  authDomain: process.env.FIREBASE_AUTH_DOMAIN || "thugparty1.firebaseapp.com",
  projectId: process.env.FIREBASE_PROJECT_ID || "thugparty1",
  storageBucket: process.env.FIREBASE_STORAGE_BUCKET || "thugparty1.firebasestorage.app",
  messagingSenderId: process.env.FIREBASE_MESSAGING_SENDER_ID || "663564615086",
  appId: process.env.FIREBASE_APP_ID || "1:663564615086:web:6b68f41403f5c8e30d1c3f"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let myName = localStorage.getItem("currentUser");
let currentBoard = "thug";
const boards = ["qa","thug","pol","shit","raid","spam"];

if (!myName) {
  showCaptcha();
} else {
  renderBoard("thug");
}

function showCaptcha() {
  let div = document.createElement("div");
  div.id = "captcha";
  div.innerHTML = "<p>Click the GREEN button</p>";
  let colors = ["red","blue","yellow","green"];
  colors.sort(() => Math.random() - 0.5);
  colors.forEach(c => {
    let b = document.createElement("button");
    b.className = "cap-btn";
    b.style.background = c;
    b.onclick = () => {
      if (c === "green") {
        div.remove();
        login();
      } else {
        alert("Wrong button. Try again.");
        showCaptcha();
      }
    };
    div.appendChild(b);
  });
  document.body.appendChild(div);
}

function login() {
  let name = prompt("Username:");
  if (!name) return;
  let pass = prompt("Password (leave blank for new account):");
  if (localStorage.getItem("accounts") && JSON.parse(localStorage.getItem("accounts"))[name] && JSON.parse(localStorage.getItem("accounts"))[name].pass !== pass) {
    alert("Wrong password");
    return login();
  }
  if (!localStorage.getItem("accounts")) localStorage.setItem("accounts", JSON.stringify({}));
  let accounts = JSON.parse(localStorage.getItem("accounts"));
  if (!accounts[name]) {
    accounts[name] = {pass: pass || "", verified: false};
    localStorage.setItem("accounts", JSON.stringify(accounts));
    alert("New unverified account created");
  }
  myName = name;
  localStorage.setItem("currentUser", myName);
  location.reload();
}

function logout() {
  localStorage.removeItem("currentUser");
  location.reload();
}

function getTimeRole() {
  if (!myName) return "";
  let loggedUsers = JSON.parse(localStorage.getItem("loggedUsers") || "{}");
  if (!loggedUsers[myName]) return "";
  let mins = Math.floor((Date.now() - loggedUsers[myName].start) / 60000);
  if (mins < 250) return "nuthug ★";
  if (mins < 350) return "midthug ♦";
  return "oldthug ♠";
}

function renderBoard(board) {
  currentBoard = board;
  let html = `<h2>/${board}/</h2>
    <p>You are: ${myName} <button onclick="logout()">Logout</button></p>
    <form id="newthread">
      Name: <input id="name" value="${myName}" readonly><br>
      Comment: <textarea id="comment"></textarea><br>
      File: <input type="file" id="file"><br>
      <button type="button" onclick="createThread()">Post</button>
    </form><div id="threads"></div>`;
  document.getElementById("content").innerHTML = html;
  loadPosts(board);
}

function loadPosts(board) {
  const postsRef = ref(db, 'posts/' + board);
  onValue(postsRef, (snapshot) => {
    const data = snapshot.val();
    let threads = [];
    if (data) {
      for (let key in data) {
        threads.push({...data[key], id: key});
      }
    }
    let threadsDiv = document.getElementById("threads");
    threadsDiv.innerHTML = "";
    threads.forEach(renderThread);
  });
}

function createThread() {
  let comment = document.getElementById("comment").value.trim();
  if (!comment) return;
  let file = document.getElementById("file").files[0];
  let fileUrl = file ? URL.createObjectURL(file) : "";
  let thread = {op:{name:myName, comment, fileUrl, time:Date.now(), verified: localStorage.getItem("accounts") ? JSON.parse(localStorage.getItem("accounts"))[myName]?.verified : false}, replies:[]};
  push(ref(db, 'posts/' + currentBoard), thread);
  document.getElementById("comment").value = "";
  document.getElementById("file").value = "";
}

function renderThread(thread) {
  let div = document.createElement("div");
  div.className = "thread";
  div.innerHTML = renderPost(thread.op, thread.id, true);
  if (thread.replies) thread.replies.forEach(r => div.innerHTML += renderPost(r, thread.id));
  div.innerHTML += `<form><input value="${myName}" readonly id="rname${thread.id}">
    <textarea id="rcomment${thread.id}"></textarea>
    <button type="button" onclick="reply('${thread.id}')">Post</button></form>`;
  document.getElementById("threads").appendChild(div);
}

function renderPost(post, threadId, isOP = false) {
  let role = roles[post.name] || "";
  let verified = post.verified ? "(verified)" : "(unverified)";
  let color = role === "owner" ? "owner" : (role === "admin" || role === "mod") ? "admin" : "";
  return `<div class="post ${isOP ? 'op' : ''}">
    <span class="name ${color}">${post.name} ${role ? '['+role+']' : ''} ${verified} ${getTimeRole()}</span>
    <span>${new Date(post.time).toLocaleString()}</span>
    ${post.fileUrl ? `<img src="${post.fileUrl}" style="max-width:300px"><br>` : ''}
    <p>${post.comment.replace(/\n/g,'<br>')}</p>
    <span class="report" onclick="reportPost('${threadId}',${post.time})">Report</span>
    ${(roles[myName] && ["owner","admin","mod"].includes(roles[myName])) ? `<span class="delete" onclick="deletePost('${currentBoard}','${threadId}',${post.time})">Delete</span>` : ''}
  </div>`;
}

function reply(threadId) {
  let comment = document.getElementById("rcomment" + threadId).value.trim();
  if (!comment) return;
  let reply = {name:myName, comment, time:Date.now(), verified: localStorage.getItem("accounts") ? JSON.parse(localStorage.getItem("accounts"))[myName]?.verified : false};
  push(ref(db, 'posts/' + currentBoard + '/' + threadId + '/replies'), reply);
  document.getElementById("rcomment" + threadId).value = "";
}

// All other functions (reportPost, deletePost, showReports, showAudit, updateUsers, owner controls) same as before

// Board click
document.querySelectorAll(".board").forEach(b => b.onclick = () => renderBoard(b.dataset.board));
if (myName) renderBoard("thug");
</script>
</body>
</html>
